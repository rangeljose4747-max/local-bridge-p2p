// Aplicaci√≥n principal Local Bridge P2P

class LocalBridgeApp {
    constructor() {
        this.screens = {
            start: document.getElementById('start-screen'),
            host: document.getElementById('host-screen'),
            join: document.getElementById('join-screen'),
            transfer: document.getElementById('transfer-screen'),
            store: document.getElementById('store-screen')
        };
        
        this.currentScreen = 'start';
        this.peerConnections = new Map();
        this.activeRoom = null;
        this.userName = this.generateRandomName();
        this.fileTransfers = new Map();
        
        this.initialize();
    }
    
    initialize() {
        this.bindEvents();
        this.setupNavigation();
        this.showNotification('Aplicaci√≥n cargada. Listo para conectar.', 'info');
    }
    
    bindEvents() {
        // Botones principales
        document.getElementById('btn-host').addEventListener('click', () => this.createRoom());
        document.getElementById('btn-join').addEventListener('click', () => this.showJoinScreen());
        document.getElementById('btn-store').addEventListener('click', () => this.showStoreScreen());
        
        // Botones de navegaci√≥n
        document.querySelectorAll('.btn-back').forEach(btn => {
            btn.addEventListener('click', () => this.showScreen('start'));
        });
        
        // Conexi√≥n
        document.getElementById('btn-connect').addEventListener('click', () => this.joinRoom());
        document.getElementById('btn-copy-code').addEventListener('click', () => this.copyRoomCode());
        
        // Transferencia de archivos
        document.getElementById('btn-select-files').addEventListener('click', () => this.selectFiles());
        document.getElementById('btn-send-files').addEventListener('click', () => this.sendSelectedFiles());
        
        // Chat
        document.getElementById('btn-close-chat').addEventListener('click', () => this.toggleChat(false));
        document.getElementById('btn-send-message').addEventListener('click', () => this.sendMessage());
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });
        
        // Tienda
        document.getElementById('btn-activate-store').addEventListener('click', () => this.activateStore());
        document.getElementById('btn-select-store-folder').addEventListener('click', () => this.selectStoreFolder());
        
        // Moneda
        document.getElementById('currency-select').addEventListener('change', (e) => {
            const exchangeInput = document.getElementById('exchange-rate');
            exchangeInput.classList.toggle('hidden', e.target.value !== 'dual');
        });
    }
    
    setupNavigation() {
        // Interceptar clicks en botones de acci√≥n
        document.querySelectorAll('[data-screen]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const screen = e.target.dataset.screen;
                if (screen) this.showScreen(screen);
            });
        });
    }
    
    showScreen(screenName) {
        // Ocultar todas las pantallas
        Object.values(this.screens).forEach(screen => {
            screen.classList.remove('active');
        });
        
        // Mostrar pantalla solicitada
        if (this.screens[screenName]) {
            this.screens[screenName].classList.add('active');
            this.currentScreen = screenName;
            
            // Ejecutar acciones espec√≠ficas de pantalla
            switch(screenName) {
                case 'host':
                    this.initializeHostScreen();
                    break;
                case 'transfer':
                    this.initializeTransferScreen();
                    break;
                case 'store':
                    this.initializeStoreScreen();
                    break;
            }
        }
    }
    
    // Generaci√≥n de sala
    async createRoom() {
        try {
            this.showScreen('host');
            
            // Generar c√≥digo de sala √∫nico
            this.activeRoom = this.generateRoomCode();
            document.getElementById('room-code').textContent = this.activeRoom;
            
            // Generar QR
            const qrContainer = document.getElementById('qrcode-container');
            qrContainer.innerHTML = '';
            
            const roomData = {
                room: this.activeRoom,
                type: 'local-bridge-p2p',
                timestamp: Date.now(),
                host: this.userName
            };
            
            new QRCode(qrContainer, {
                text: JSON.stringify(roomData),
                width: 256,
                height: 256,
                colorDark: '#2563eb',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Iniciar WebRTC para esperar conexiones
            await this.initializeWebRTC(true);
            
            this.showNotification('Sala creada. Comparte el c√≥digo con quien quieras conectar.', 'success');
            
        } catch (error) {
            console.error('Error creando sala:', error);
            this.showNotification('Error al crear la sala', 'error');
        }
    }
    
    generateRoomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Sin caracteres ambiguos
        let code = '';
        for (let i = 0; i < 9; i++) {
            if (i > 0 && i % 3 === 0) code += '-';
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }
    
    generateRandomName() {
        const adjectives = ['R√°pido', 'Seguro', 'Local', 'Directo', 'Privado', 'Digital'];
        const nouns = ['Puente', 'Conexi√≥n', 'Enlace', 'Portal', 'T√∫nel', 'Red'];
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        return `${adj} ${noun}`;
    }
    
    // Unirse a sala
    async joinRoom() {
        const roomCode = document.getElementById('room-input').value.trim();
        
        if (!roomCode) {
            this.showNotification('Ingresa un c√≥digo de sala', 'error');
            return;
        }
        
        try {
            this.activeRoom = roomCode;
            
            // Conectar via WebRTC
            await this.initializeWebRTC(false);
            
            this.showScreen('transfer');
            this.showNotification('Conectado a la sala', 'success');
            
        } catch (error) {
            console.error('Error uni√©ndose a sala:', error);
            this.showNotification('Error al conectar', 'error');
        }
    }
    
    showJoinScreen() {
        this.showScreen('join');
    }
    
    showStoreScreen() {
        this.showScreen('store');
    }
    
    // WebRTC
    async initializeWebRTC(isHost) {
        // Esta funci√≥n se implementar√≠a con webrtc-bridge.js
        console.log(`Inicializando WebRTC como ${isHost ? 'host' : 'guest'}`);
        
        // Por ahora, simulamos una conexi√≥n exitosa despu√©s de 2 segundos
        setTimeout(() => {
            this.onConnectionEstablished();
        }, 2000);
    }
    
    onConnectionEstablished() {
        document.getElementById('connection-state').className = 'state-connected';
        document.getElementById('connection-state').innerHTML = 
            '<i class="fas fa-check-circle"></i> Conectado P2P';
        
        // Habilitar botones
        document.querySelectorAll('.btn-action').forEach(btn => {
            btn.disabled = false;
        });
        
        // Mostrar chat autom√°ticamente
        this.toggleChat(true);
        
        this.showNotification('Conexi√≥n P2P establecida directamente entre PCs', 'success');
    }
    
    // Manejo de archivos
    async selectFiles() {
        try {
            const fileHandles = await window.showOpenFilePicker({
                multiple: true,
                types: [{
                    description: 'Todos los archivos',
                    accept: {'*/*': ['.*']}
                }]
            });
            
            const filesList = document.getElementById('local-files');
            filesList.innerHTML = '';
            
            for (const fileHandle of fileHandles) {
                const file = await fileHandle.getFile();
                this.addFileToList(file);
            }
            
            // Habilitar bot√≥n de enviar
            document.getElementById('btn-send-files').disabled = false;
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error seleccionando archivos:', error);
                this.showNotification('Error al seleccionar archivos', 'error');
            }
        }
    }
    
    addFileToList(file) {
        const filesList = document.getElementById('local-files');
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.fileId = Date.now() + Math.random();
        
        fileItem.innerHTML = `
            <div class="file-info">
                <i class="fas fa-file file-icon"></i>
                <div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${this.formatFileSize(file.size)}</div>
                </div>
            </div>
            <button class="btn-remove-file">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Agregar evento para eliminar archivo
        fileItem.querySelector('.btn-remove-file').addEventListener('click', () => {
            fileItem.remove();
            this.checkFilesList();
        });
        
        filesList.appendChild(fileItem);
    }
    
    checkFilesList() {
        const filesList = document.getElementById('local-files');
        const isEmpty = filesList.children.length === 0;
        
        document.getElementById('btn-send-files').disabled = isEmpty;
        
        if (isEmpty) {
            filesList.innerHTML = '<p class="empty-message">No hay archivos seleccionados</p>';
        }
    }
    
    async sendSelectedFiles() {
        // Implementar env√≠o real via WebRTC
        this.showNotification('Enviando archivos directamente al peer...', 'info');
        
        // Simular progreso
        this.showTransferProgress();
        
        setTimeout(() => {
            this.showNotification('Archivos enviados exitosamente', 'success');
            this.hideTransferProgress();
        }, 3000);
    }
    
    showTransferProgress() {
        const progress = document.getElementById('transfer-progress');
        progress.classList.remove('hidden');
        
        // Simular progreso
        let percent = 0;
        const interval = setInterval(() => {
            percent += 5;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${percent}%`;
            
            if (percent >= 100) {
                clearInterval(interval);
            }
        }, 100);
    }
    
    hideTransferProgress() {
        document.getElementById('transfer-progress').classList.add('hidden');
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-text').textContent = '0%';
    }
    
    // Chat
    toggleChat(show) {
        const chatWindow = document.getElementById('chat-window');
        if (show) {
            chatWindow.classList.remove('hidden');
        } else {
            chatWindow.classList.add('hidden');
        }
    }
    
    sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Agregar mensaje localmente
        this.addMessageToChat(message, true);
        
        // Enviar via WebRTC (simulado por ahora)
        console.log('Enviando mensaje via P2P:', message);
        
        // Simular respuesta despu√©s de 1 segundo
        setTimeout(() => {
            this.addMessageToChat('Mensaje recibido via P2P', false);
        }, 1000);
        
        input.value = '';
    }
    
    addMessageToChat(message, isSent) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.textContent = message;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Tienda
    async selectStoreFolder() {
        try {
            const directoryHandle = await window.showDirectoryPicker();
            const pathElement = document.getElementById('store-folder-path');
            pathElement.textContent = directoryHandle.name;
            pathElement.dataset.handle = 'selected';
            
            // Escanear carpeta para productos
            await this.scanFolderForProducts(directoryHandle);
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                this.showNotification('Error seleccionando carpeta', 'error');
            }
        }
    }
    
    async scanFolderForProducts(directoryHandle) {
        // Implementar escaneo de carpeta
        this.showNotification('Escaneando carpeta para productos...', 'info');
        
        // Por ahora, mostrar productos de ejemplo
        setTimeout(() => {
            this.displaySampleProducts();
        }, 1500);
    }
    
    displaySampleProducts() {
        const productsGrid = document.getElementById('products-grid');
        productsGrid.innerHTML = '';
        
        const sampleProducts = [
            { name: 'Producto 1', price: 25.99, image: 'üì±' },
            { name: 'Producto 2', price: 15.50, image: 'üíª' },
            { name: 'Producto 3', price: 8.75, image: 'üéß' },
            { name: 'Producto 4', price: 12.00, image: '‚åö' }
        ];
        
        sampleProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            
            productCard.innerHTML = `
                <div class="product-image">${product.image}</div>
                <h4>${product.name}</h4>
                <div class="product-price">$${product.price.toFixed(2)}</div>
                <p>Producto desde carpeta local</p>
                <button class="btn-add-to-cart">
                    <i class="fas fa-cart-plus"></i> Agregar
                </button>
            `;
            
            productCard.querySelector('.btn-add-to-cart').addEventListener('click', () => {
                this.addToCart(product);
            });
            
            productsGrid.appendChild(productCard);
        });
    }
    
    addToCart(product) {
        // Implementar carrito
        this.showNotification(`${product.name} agregado al carrito`, 'success');
    }
    
    activateStore() {
        const storeName = document.getElementById('store-name').value || 'Mi Tienda Local';
        const currency = document.getElementById('currency-select').value;
        
        document.getElementById('store-preview').classList.remove('hidden');
        document.getElementById('store-cart').classList.remove('hidden');
        
        // Generar QR para la tienda
        const storeData = {
            store: storeName,
            currency: currency,
            owner: this.userName,
            timestamp: Date.now(),
            type: 'local-store'
        };
        
        const qrContainer = document.getElementById('store-qrcode');
        qrContainer.innerHTML = '';
        
        new QRCode(qrContainer, {
            text: JSON.stringify(storeData),
            width: 128,
            height: 128,
            colorDark: '#10b981',
            colorLight: '#ffffff'
        });
        
        this.showNotification('Tienda activada. Comparte el c√≥digo QR.', 'success');
    }
    
    // Utilidades
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    copyRoomCode() {
        const code = document.getElementById('room-code').textContent;
        navigator.clipboard.writeText(code)
            .then(() => this.showNotification('C√≥digo copiado al portapapeles', 'success'))
            .catch(() => this.showNotification('Error al copiar c√≥digo', 'error'));
    }
    
    showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                               type === 'error' ? 'exclamation-circle' : 
                               'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        container.appendChild(notification);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    initializeHostScreen() {
        console.log('Inicializando pantalla de host');
    }
    
    initializeTransferScreen() {
        console.log('Inicializando pantalla de transferencia');
    }
    
    initializeStoreScreen() {
        console.log('Inicializando pantalla de tienda');
    }
}

// Iniciar aplicaci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    window.app = new LocalBridgeApp();
    
    // Verificar compatibilidad
    if (!('showOpenFilePicker' in window)) {
        window.app.showNotification(
            'Tu navegador puede tener limitaciones. Usa Chrome/Edge 86+ o Firefox 111+ para mejor experiencia.',
            'warning'
        );
    }
    
    if (!('RTCPeerConnection' in window)) {
        window.app.showNotification(
            'WebRTC no est√° soportado. No podr√°s establecer conexiones P2P.',
            'error'
        );
    }
});
